---
title: "교통사고 기술통계분석 및 GPS 좌표 시각화"
output:
  html_document: 
    keep_md: yes
---  
***

## < 분석 개요 >  

**1. 데이터**  
**- 2012 ~ 2014 교통사망사고 정보**  
**- 평택시 CCTV 현황**  
**- 화성시 CCTV 현황**  
  
**2. 목적**  
**- 기술통계분석**  
: 요약 통계량으로 교통사고사상자 증감 추이와 보험사기 연관성 파악  
**- GPS 좌표 시각화**  
: 경기도 내 최다 사고 지역과 GPS 좌표를 이용한 사고발생 현황 및 CCTV 취약지 시각화  

***
  
### # 패키지 로드
```{r message = F, warning = F}
library(plyr)
library(ggplot2)
library(dplyr)
library(stringr)
library(lubridate)
library(ggmap)
library(reshape)
```

## 1. 데이터 로드
```{r}
# 경로 지정
# setwd("C:/Users/Windows10/Desktop/Project/data")

# 데이터 로드
raw <- read.csv("C:/Users/Windows10/Desktop/Project/data/2012_2014_교통사망사고정보.csv")

# 데이터 확인
str(raw)
```

## 2. 데이터 전처리
### 1) 'time' 변수 생성 (시간 데이터 정제)
```{r}
raw$발생일 <- as.character(raw$발생일)
raw$발생시간 <- as.character(raw$발생시간)

# 각 자리에서 년, 월, 일, 시간을 분리
hour <- str_sub(raw$발생시간, 1, 2) %>% paste('00', sep=':')

year <- str_sub(raw$발생일, 1, 4)
month <- str_sub(raw$발생일, 5, 6)
day <- str_sub(raw$발생일, 7, 8)

# 새로운 time 변수
time <- paste(year, month, day, sep='-') %>% paste(hour, sep=' ')
time <- as.POSIXct(time)
```

### 2) 'site' 변수 생성
```{r}
# ex) 경기도 수원시
site <- paste(raw$발생지_시도, raw$발생지_시군구, sep='')
```

### 3) 'total'(총 사상자) 변수 생성
```{r}
# 사망자 수 + 중상자 수 + 경상자 수 + 부상신고자 수 = 총 사상자 수
total <- c()
for (i in 1:nrow(raw)){
  total[i] <- raw[i,8] + raw[i,9] + raw[i,10] + raw[i,11] + raw[i,12]
}
```


```{r}
# 더미 변수 생성
freq <- rep(1, nrow(raw))

# 새 변수들 병합
data <- cbind(raw, time, site, freq, total)
head(data)
```

## 3. 교통사고사상자 증감 추이 분석
### 1) 년도별 추세 확인
##### *부상신고자수: 교통사고 발생시 본인이 사고를 당하였다고 신고한 사람의 수
```{r}
# 년도별 사상자 수, 발생 빈도 요약 통계
sum_by_year <- ddply(data, .(발생년), summarise, dead=sum(사망자수), hard_hit=sum(중상자수), simple_hit=sum(경상자수), 
                     report_hit=sum(부상신고자수), freq=sum(freq)) %>% data.frame()

# 열 이름 변경
colnames(sum_by_year) <- c("발생년도", "사망자수", "중상자수", "경상자수", "부상신고자수", "교통사고발생수")

sum_by_year
```

### 2) 분기별 추세 확인
```{r}
# 분기별 분류
year2012 <- filter(data, 발생년 == "2012")
year2013 <- filter(data, 발생년 == "2013")
year2014 <- filter(data, 발생년 == "2014")

# 년도/분기별 합계
sum_by_quarter_2012 <- ddply(year2012, .(quarter(time)), summarise, dead=sum(사망자수), hard_hit=sum(중상자수),
                             simple_hit=sum(경상자수), report_hit=sum(부상신고자수), freq=sum(freq)) %>% data.frame()
sum_by_quarter_2013 <- ddply(year2013, .(quarter(time)), summarise, dead=sum(사망자수), hard_hit=sum(중상자수),
                             simple_hit=sum(경상자수), report_hit=sum(부상신고자수), freq=sum(freq)) %>% data.frame()
sum_by_quarter_2014 <- ddply(year2014, .(quarter(time)), summarise, dead=sum(사망자수), hard_hit=sum(중상자수),
                             simple_hit=sum(경상자수), report_hit=sum(부상신고자수), freq=sum(freq)) %>% data.frame()

sum_by_quarter <- rbind(sum_by_quarter_2012, sum_by_quarter_2013, sum_by_quarter_2014)
head(sum_by_quarter)
```
```{r}
#필요 없는 변수 제거
sum_by_quarter <- sum_by_quarter[,-1]

# 년도 변수 생성
year_quarter <- c(2012.1, 2012.2, 2012.3, 2012.4, 
                  2013.1, 2013.2, 2013.3, 2013.4, 
                  2014.1, 2014.2, 2014.3, 2014.4)
# 병합
sum_by_quarter <- cbind(year_quarter, sum_by_quarter)

colnames(sum_by_quarter) <- c("발생년도", "사망자수", "중상자수", "경상자수", "부상신고자수", "교통사고발생수")
head(sum_by_quarter)
```

### 3) 시각화
```{r}
# 발생년도 기준으로 melt
sum_by_quarter_melt <- melt(sum_by_quarter, id.vars = "발생년도")

# ggplot
ggplot() + geom_line(data=sum_by_quarter_melt, aes(x=발생년도, y=value, group=variable, color=variable), size=1.5)
```

- 전체 교통사고 수, 사상자 수는 매년 감소하지만, 부상신고자수는 증가하고 있음
  50만원에서 150만원으로 상향된 대물할증 기분금액과 급증하고 있는 보험사기율과 연관성이 있는 것으로 보임
  
## 4. 교통사망사고가 높은 지역과 CCTV 분석
### 1) 경기도 내 사망사고가 가장 많이 발생한 시군구
```{r}
# 경기도 데이터 추출
kyonggi <- filter(data, 발생지_시도 == "경기")

# 경기도 시군구 별 교통사고 발생횟수
acc_freq <- tapply(kyonggi$freq, kyonggi$발생지_시군구, sum, na.rm=T)

# NA(결측값) 제외
acc_freq_frame <- data.frame(acc_freq[-which(is.na(acc_freq))])
colnames(acc_freq_frame) <- c("사망사고")
acc_freq_frame
``` 

- 화성시가 205회로 사망사고가 가장 높았고
  평택, 용인, 수원 순서로 2012 ~ 2014년 동안 교통사고가 가장 많이 발생함

### 2) 화성, 평택시의 교통사망사고와 교통단속 CCTV의 상관성
```{r}
# 화성, 평택시 데이터 추출
target_h <- filter(data, 발생지_시군구 == "화성시")
target_p <- filter(data, 발생지_시군구 == "평택시")

# 화성, 평택시 CCTV 데이터 로드
# 화성시
hwaseong <- read.csv("C:/Users/Windows10/Desktop/Project/data/경기도+화성시_CCTV_20160908.csv")
str(hwaseong)
h_ac <- filter(hwaseong, 설치목적구분 %in% c("교통단속", "다목적", "어린이보호"))

# 평택시
pyeongtaek <- read.csv("C:/Users/Windows10/Desktop/Project/data/경기도+평택시_CCTV_20160905.csv")
str(pyeongtaek)
p_ac <- filter(pyeongtaek, 설치목적구분 %in% c("교통단속", "어린이보호"))
```

- 설치목적상 시설물관리, 생활방범, 차량방범, 공원관리와 같은 목적이 확실한 CCTV를 제외하고
  교통단속의 목적을 수행할 가능성이 있는  CCTV 추출

### 3) 4분위수를 통해 위험지역 판단
```{r}
summary(data$total)

# 화성시
low_h <- filter(target_h, total <= 1)
mid_h <- filter(target_h, total > 1 & total <= 3)
high_h <- filter(target_h, total > 3)

# 평택시
low_p <- filter(target_p, total <= 1)
mid_p <- filter(target_p, total > 1 & total <= 3)
high_p <- filter(target_p, total > 3)
```

### 4) 사고발생위치의 중심점 도출 및 시각화
```{r}
#library(devtools)
#devtools::install_github("dkahle/ggmap")
#register_google(key = "AIzaSyBq-g9JUyBgbOZ2nF4VnFRjhlh6_fNBtp4")
#qmap()

# GPS 좌표 위도, 경도와 평균을 구해서 중심점 도출
#cent_h <- c(mean(target_h$X.Grd.경도.), mean(target_h$Y.Grd.위도.))
#cent_p <- c(mean(target_p$Y.Grd.위도.), mean(target_p$Y.Grd.위도.))

# 화성시 시각화
#h_map <- get_map(location=cent_h, color="color", source="google", maptype="roadmap", zoom=11)

#ggmap(h_map) + 
#  geom_point(data=high_h, aes(x=X.Grd.경도., y=Y.Grd.위도.), size=6, alpha=1, color="#FF00FF") +
#  geom_point(data=mid_h, aes(x=X.Grd.경도., y=Y.Grd.위도.), alpha=1, col="red", size=5) +
#  geom_point(data=low_h, aes(x=X.Grd.경도., y=Y.Grd.위도.), alpha=1, col="#FF7518", size=4) +
#  geom_point(data=h_ac, aes(x=경도, y=위도), alpha=1, col="green", size=3)
```
